{{ define "page" }}
<main class="document-single">
    <div class="document-single-left">
        <h1 class="document-single-title" id="title" contenteditable>
            {{ .Document.Title }}
        </h1>

        <div class="document-single-body" id="text" contenteditable>
            {{ .DocumentBody }}
        </div>
    </div>

    <div class="document-single-right">
        <div class="saving">
            <div class="saving-text" id="save-alert">text autosaved now</div>
        </div>

        <div class="suggestion-help" id="suggestion-help">
            Mark any word or phrase you want to change
        </div>

        <div class="suggestion-original">
            <div class="suggestion-original-content" id="sug-original">
                <!-- placeholder -->
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="loading-indicator"></div>
        </div>

        <div class="suggestion-prediction">
            <div class="suggestion-prediction-content" id="sug-pred1">
                <!-- placeholder -->
            </div>
        </div>
        <div class="suggestion-prediction">
            <div class="suggestion-prediction-content" id="sug-pred2">
                <!-- placeholder -->
            </div>
        </div>
        <div class="suggestion-prediction">
            <div class="suggestion-prediction-content" id="sug-pred3">
                <!-- placeholder -->
            </div>
        </div>
    </div>
</main>
{{ end }}

{{ define "scripts" }}
<script>
    var STORED_SELECTION_RANGE = null;

    function cleanupSuggestions() {
        document.getElementById('sug-original').innerText = '';
        document.getElementById('sug-pred1').innerText = '';
        document.getElementById('sug-pred2').innerText = '';
        document.getElementById('sug-pred3').innerText = '';
        document.getElementById('suggestion-help').style.display = 'block';
    }

    function saveDocument() {
        const data = {
            title: document.getElementById('title').innerText,
            body: document.getElementById('text').innerText,
        };
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/text/' + window.location.pathname.split('/')[2] + '/update', true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onload = function () {
            if (xhr.status === 200) {
                document.getElementById('save-alert').style.transition = 'none';
                document.getElementById('save-alert').style.opacity = 1;
                setTimeout(function () {
                    document.getElementById('save-alert').style.opacity = 0;
                    document.getElementById('save-alert').style.transition = 'opacity 0.3s ease-out';
                }, 2000);
            } else {
                document.getElementById('save-alert').innerText = 'error saving text';
            }
        };
        xhr.send(JSON.stringify(data));
    }

    function loadSuggestions() {
        const selection = window.getSelection();
        if (selection.toString()) {
            // store selection and start loading
            STORED_SELECTION_RANGE = selection.getRangeAt(0);
            cleanupSuggestions();
            document.getElementById('suggestion-help').style.display = 'none';
            document.getElementById('loading').style.display = 'block';

            // show original selection
            document.getElementById('sug-original').innerText = selection.toString();

            let prompt = 'respond with three synonyms of this word, separated by |: ' + selection.toString();
            if (selection.toString().split(' ').length > 1) {
                prompt = 'respond with three separate rephrases of this phrase, separated by |: ' + selection.toString();
            }

            // get suggestions
            const data = {
                prompt,
                model: 'gpt3p5',
            };
            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/api/v1/evaluate', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.setRequestHeader('Authorization', 'Bearer {{ .Token }}');
            xhr.onload = function () {
                if (xhr.status === 200) {
                    const data = JSON.parse(xhr.response);
                    const split = data.result.split('|');

                    // show suggestions
                    document.getElementById('sug-pred1').innerText = split[0];
                    document.getElementById('sug-pred2').innerText = split[1];
                    document.getElementById('sug-pred3').innerText = split[2];

                    // hide loader
                    document.getElementById('loading').style.display = 'none';
                } else {
                    console.log('Request failed. Returned status of ' + xhr.status);
                }
            };
            xhr.send(JSON.stringify(data));
        }
    }

    function replaceSelection(newText) {
        const range = STORED_SELECTION_RANGE;
        range.deleteContents();
        range.insertNode(document.createTextNode(newText));
        STORED_SELECTION_RANGE = null;
        cleanupSuggestions();
    }

    window.addEventListener('DOMContentLoaded', function() {
        if (window.location.pathname.indexOf('/text/') !== 0) {
            // do nothing if it's not a text page
            return;
        }

        // init saving loader
        // document.getElementById('save-alert').style.opacity = 0;

        // save the document when the user changes title or body
        document.getElementById('title').addEventListener('input', saveDocument);
        document.getElementById('text').addEventListener('input', saveDocument);

        // when user selects text, replace it
        document.getElementById('text').addEventListener('mouseup', loadSuggestions);
        document.getElementById('text').addEventListener('keyup', loadSuggestions);

        // when user clicks on a suggestion, replace the selection
        document.getElementById('sug-pred1').addEventListener('click', function () {
            replaceSelection(document.getElementById('sug-pred1').innerText);
        });
        document.getElementById('sug-pred2').addEventListener('click', function () {
            replaceSelection(document.getElementById('sug-pred2').innerText);
        });
        document.getElementById('sug-pred3').addEventListener('click', function () {
            replaceSelection(document.getElementById('sug-pred3').innerText);
        });
    });
</script>
{{ end }}
